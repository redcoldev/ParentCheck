<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Screening…</title>

<style>
    body {
        font-family: Arial, sans-serif;
        background: #f5f5f5;
        padding: 10px 20px;
    }

    h1 {
        margin: 0 0 10px 0;
        font-size: 18px;
        font-weight: 600;
        color: #333;
    }

    table {
        width: 100%;
        border-collapse: collapse;
        background: white;
        font-size: 13px;
    }

    th, td {
        border: 1px solid #ccc;
        padding: 6px 8px;
        vertical-align: top;
    }

    th {
        background: #f0f0f0;
        font-weight: 600;
        text-align: left;
    }

    .status {
        font-weight: 600;
    }

    .clear { color: #1a7f1a; }
    .match { color: #b30000; }

    tbody tr:nth-child(even) {
        background: #fafafa;
    }

    .debug {
        font-size: 11px;
        color: #444;
        white-space: pre-wrap;
        max-width: 400px;
    }
</style>
</head>
<body>

<h1>Running Screening…</h1>

<table id="resultTable">
    <thead>
        <tr>
            <th>Name</th>
            <th>DOB</th>
            <th>Country</th>
            <th>Status</th>
            <th>Summary</th>
            <th>Details</th>
            <th>Debug</th>
        </tr>
    </thead>
    <tbody id="tableBody"></tbody>
</table>

<script>
    const rows = {{ rows_json | safe }};
    const batchId = {{ batch_id }};
    let index = 0;

    async function processNext() {
        if (index >= rows.length) return;

        const row = rows[index];

        const tr = document.createElement("tr");
        tr.innerHTML = `
            <td>${row.first_name} ${row.last_name}</td>
            <td>${row.dob || ""}</td>
            <td>${row.country_of_citizenship || ""}</td>
            <td class="status" id="status-${index}">Checking…</td>
            <td id="summary-${index}">—</td>
            <td id="details-${index}">—</td>
            <td class="debug" id="debug-${index}">—</td>
        `;
        document.getElementById("tableBody").appendChild(tr);

        try {
            const resp = await fetch("/api/screen", {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify(row)
            });
            const data = await resp.json();

            const statusEl  = document.getElementById(`status-${index}`);
            const summaryEl = document.getElementById(`summary-${index}`);
            const detailsEl = document.getElementById(`details-${index}`);
            const debugEl   = document.getElementById(`debug-${index}`);

            if (data.risk === "Clear") {
                statusEl.textContent = "✓ Clear";
                statusEl.classList.add("clear");
            } else {
                statusEl.textContent = "⚠ Match";
                statusEl.classList.add("match");
            }

            summaryEl.textContent = data.summary || "(no summary)";

            const details = [];

            if (data.datasets?.length > 0) {
                details.push("<strong>Lists:</strong> " + data.datasets.join(", "));
            }

            if (data.aliases?.length > 0) {
                details.push("<strong>Aliases:</strong> " + data.aliases.slice(0, 5).join(", "));
            }

            if (data.birth_date?.length > 0) {
                details.push("<strong>Birth date:</strong> " + data.birth_date.join(", "));
            }

            if (data.birth_place?.length > 0) {
                details.push("<strong>Birthplace:</strong> " + data.birth_place.join(", "));
            }

            if (data.citizenship?.length > 0) {
                details.push("<strong>Citizenship:</strong> " + data.citizenship.join(", "));
            }

            if (data.nationality?.length > 0) {
                details.push("<strong>Nationality:</strong> " + data.nationality.join(", "));
            }

            if (data.positions?.length > 0) {
                details.push("<strong>Positions:</strong> " + data.positions.join(", "));
            }

            if (data.sanctions?.length > 0) {
                const lines = data.sanctions.map(s => {
                    const prog = s.program || "Unknown program";
                    const date = s.listingDate || "";
                    const reason = s.reason || "";
                    return `${prog}${date ? " — " + date : ""}${reason ? " — \"" + reason + "\"" : ""}`;
                });
                details.push("<strong>Sanctions:</strong><br>• " + lines.join("<br>• "));
            }

            if (data.topics?.length > 0) {
                details.push("<strong>Topics:</strong> " + data.topics.join(", "));
            }

            if (data.profile) {
                const short = data.profile.length > 150
                    ? data.profile.substring(0, 150) + "…"
                    : data.profile;
                details.push("<strong>Profile:</strong> " + short);
            }

            detailsEl.innerHTML = details.length > 0 ? details.join("<br>") : "—";

            debugEl.textContent = JSON.stringify(data.debug, null, 2);

        } catch (err) {
            document.getElementById(`status-${index}`).textContent  = "❌ Error";
            document.getElementById(`summary-${index}`).textContent = err.toString();
            document.getElementById(`details-${index}`).textContent = "—";
            document.getElementById(`debug-${index}`).textContent   = err.toString();
        }

        index++;
        processNext();
    }

    processNext();
</script>

</body>
</html>
