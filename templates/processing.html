<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Screening…</title>
<style>
    body {
        font-family: Inter, sans-serif;
        background: #fafafa;
        padding: 20px;
    }
    h1 { margin-bottom: 20px; }
    table {
        width: 100%;
        border-collapse: collapse;
        background: white;
    }
    th, td {
        border: 1px solid #ddd;
        padding: 10px;
    }
    th { background: #eee; }
    .status {
        font-weight: bold;
    }
    .clear { color: green; }
    .match { color: #c00; }
</style>
</head>
<body>

<h1>Running Screening…</h1>

<table id="resultTable">
    <thead>
        <tr>
            <th>Name</th>
            <th>DOB</th>
            <th>Country</th>
            <th>Status</th>
            <th>Summary</th>
        </tr>
    </thead>
    <tbody id="tableBody">
    </tbody>
</table>

<script>
    const rows = {{ rows_json | safe }};
    const batchId = {{ batch_id }};
    let index = 0;

    async function processNext() {
        if (index >= rows.length) {
            return;
        }

        const row = rows[index];

        // Create table row first
        const tr = document.createElement("tr");
        tr.innerHTML = `
            <td>${row.first_name} ${row.last_name}</td>
            <td>${row.dob || ""}</td>
            <td>${row.country || ""}</td>
            <td class="status" id="status-${index}">Checking…</td>
            <td id="summary-${index}">—</td>
        `;
        document.getElementById("tableBody").appendChild(tr);

        // Call backend to screen single record
        try {
            const resp = await fetch("/api/screen", {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify(row)
            });
            const data = await resp.json();

            const statusEl = document.getElementById(`status-${index}`);
            const summaryEl = document.getElementById(`summary-${index}`);

            if (data.risk === "Clear") {
                statusEl.textContent = "✓ Clear";
                statusEl.classList.add("clear");
            } else {
                statusEl.textContent = "⚠ Match";
                statusEl.classList.add("match");
            }

            summaryEl.textContent = data.summary || "(no details)";

        } catch (err) {
            document.getElementById(`status-${index}`).textContent = "❌ Error";
            document.getElementById(`summary-${index}`).textContent = err.toString();
        }

        index++;
        processNext();
    }

    processNext();
</script>

</body>
</html>
